{% extends "base.html" %}

{% block title %}需求详情 - {{ requirement.requirement_code }} - 服务器订单管理系统{% endblock %}

{% block extra_css %}
<style>
    .config-item-row {
        margin-bottom: 10px;
    }
</style>
{% endblock %}

{% block content %}
<div class="row mt-4">
    <div class="col-12">
        <!-- 需求基本信息 -->
        <div class="card mb-3">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h3>需求详情</h3>
                <div>
                    <a href="{{ url_for('requirement.edit_requirement', requirement_id=requirement.id) }}" 
                       class="btn btn-warning">编辑需求</a>
                    <a href="{{ url_for('requirement.list_requirements') }}" 
                       class="btn btn-secondary">返回列表</a>
                </div>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <p><strong>需求编码:</strong> {{ requirement.requirement_code }}</p>
                        <p><strong>Jira Case:</strong> {{ requirement.jira_case }}</p>
                        <p><strong>状态:</strong> 
                            <span class="badge bg-{{ 'secondary' if requirement.status == 'draft' else 'success' if requirement.status == 'approved' else 'primary' }}">
                                {{ requirement.status }}
                            </span>
                        </p>
                    </div>
                    <div class="col-md-6">
                        <p><strong>创建时间:</strong> {{ requirement.created_at.strftime('%Y-%m-%d %H:%M:%S') if requirement.created_at else '' }}</p>
                        <p><strong>更新时间:</strong> {{ requirement.updated_at.strftime('%Y-%m-%d %H:%M:%S') if requirement.updated_at else '' }}</p>
                    </div>
                </div>
                {% if requirement.description %}
                <div class="row mt-2">
                    <div class="col-12">
                        <p><strong>描述:</strong></p>
                        <p>{{ requirement.description }}</p>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- 配置方案列表 -->
        <div class="card mb-3">
            <div class="card-header">
                <h4>配置方案</h4>
            </div>
            <div class="card-body">
                {% if configurations %}
                {% for config in configurations %}
                <div class="card mb-3">
                    <div class="card-header bg-light">
                        <h5>{{ config.config_name }}</h5>
                        <p class="mb-0"><strong>总价:</strong> ¥{{ "%.2f"|format(config.total_price) }}</p>
                    </div>
                    <div class="card-body">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>SKU编码</th>
                                    <th>SKU名称</th>
                                    <th>数量</th>
                                    <th>单价</th>
                                    <th>小计</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for item in config.items %}
                                <tr>
                                    <td>{{ item.sku.sku_code }}</td>
                                    <td>{{ item.sku.name }}</td>
                                    <td>{{ item.quantity }}</td>
                                    <td>¥{{ "%.2f"|format(item.unit_price) }}</td>
                                    <td>¥{{ "%.2f"|format(item.subtotal) }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
                {% endfor %}
                {% else %}
                <div class="alert alert-info">
                    暂无配置方案
                </div>
                {% endif %}
            </div>
        </div>

        <!-- 添加配置方案表单 -->
        <div class="card">
            <div class="card-header">
                <h4>添加配置方案</h4>
            </div>
            <div class="card-body">
                <form method="post" action="{{ url_for('requirement.add_configuration', requirement_id=requirement.id) }}" id="configForm">
                    <div class="mb-3">
                        <label for="config_name" class="form-label">配置名称 <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="config_name" name="config_name" required>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">配置项</label>
                        <div id="configItems">
                            <div class="config-item-row row">
                                <div class="col-md-5">
                                    <select class="form-select sku-select" name="sku_id[]" required>
                                        <option value="">选择SKU</option>
                                        {% for sku in skus %}
                                        <option value="{{ sku.id }}" data-price="{{ sku.unit_price }}">
                                            {{ sku.sku_code }} - {{ sku.name }} (¥{{ "%.2f"|format(sku.unit_price) }})
                                        </option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <input type="number" class="form-control quantity-input" name="quantity[]" 
                                           placeholder="数量" min="1" required>
                                </div>
                                <div class="col-md-3">
                                    <input type="text" class="form-control subtotal-display" readonly placeholder="小计">
                                </div>
                                <div class="col-md-1">
                                    <button type="button" class="btn btn-danger btn-sm remove-item" style="display:none;">删除</button>
                                </div>
                            </div>
                        </div>
                        <button type="button" class="btn btn-sm btn-secondary mt-2" id="addItem">添加配置项</button>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">配置总价</label>
                        <input type="text" class="form-control" id="totalPrice" readonly placeholder="¥0.00">
                    </div>

                    <button type="submit" class="btn btn-primary">添加配置</button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const configItemsContainer = document.getElementById('configItems');
    const addItemBtn = document.getElementById('addItem');
    const totalPriceInput = document.getElementById('totalPrice');

    // 添加配置项
    addItemBtn.addEventListener('click', function() {
        const firstRow = configItemsContainer.querySelector('.config-item-row');
        const newRow = firstRow.cloneNode(true);
        
        // 清空新行的值
        newRow.querySelectorAll('input, select').forEach(input => {
            if (input.classList.contains('subtotal-display')) {
                input.value = '';
            } else {
                input.value = '';
            }
        });
        
        // 显示删除按钮
        newRow.querySelector('.remove-item').style.display = 'inline-block';
        
        configItemsContainer.appendChild(newRow);
        attachEventListeners(newRow);
    });

    // 删除配置项
    function attachEventListeners(row) {
        const removeBtn = row.querySelector('.remove-item');
        const skuSelect = row.querySelector('.sku-select');
        const quantityInput = row.querySelector('.quantity-input');
        
        removeBtn.addEventListener('click', function() {
            row.remove();
            calculateTotal();
        });
        
        skuSelect.addEventListener('change', calculateRowSubtotal);
        quantityInput.addEventListener('input', calculateRowSubtotal);
        
        function calculateRowSubtotal() {
            const selectedOption = skuSelect.options[skuSelect.selectedIndex];
            const price = parseFloat(selectedOption.dataset.price || 0);
            const quantity = parseInt(quantityInput.value || 0);
            const subtotal = price * quantity;
            
            const subtotalDisplay = row.querySelector('.subtotal-display');
            subtotalDisplay.value = subtotal > 0 ? '¥' + subtotal.toFixed(2) : '';
            
            calculateTotal();
        }
    }

    // 计算总价
    function calculateTotal() {
        let total = 0;
        configItemsContainer.querySelectorAll('.config-item-row').forEach(row => {
            const skuSelect = row.querySelector('.sku-select');
            const quantityInput = row.querySelector('.quantity-input');
            const selectedOption = skuSelect.options[skuSelect.selectedIndex];
            const price = parseFloat(selectedOption.dataset.price || 0);
            const quantity = parseInt(quantityInput.value || 0);
            total += price * quantity;
        });
        
        totalPriceInput.value = total > 0 ? '¥' + total.toFixed(2) : '¥0.00';
    }

    // 为初始行附加事件监听器
    configItemsContainer.querySelectorAll('.config-item-row').forEach(row => {
        attachEventListeners(row);
    });
});
</script>
{% endblock %}
